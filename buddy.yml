- pipeline: "Pull Request Tests"
  trigger_mode: "ON_EVERY_PUSH"
  ref_name: "refs/pull/*"
  ref_type: "WILDCARD"
  priority: "NORMAL"
  target_site_url: "https://github.com/alleyinteractive/ad-layers"
  fetch_all_refs: true
  fail_on_prepare_env_warning: true
  clone_depth: 1
  trigger_condition: "ALWAYS"
  actions:
    - action: "Gitignored files check"
      type: "BUILD"
      working_directory: "/buddy/ad-layers"
      docker_image_name: "alleyops/ci-resources"
      docker_image_tag: "7.4-fpm-wp"
      execute_commands:
        - "if [[ ! -z $(git ls-files -i --exclude-standard) ]]; then exit 1; fi"
      volume_mappings:
        - "/:/buddy/ad-layers"
      trigger_condition: "ALWAYS"
      shell: "BASH"
      run_next_parallel: true
    - action: "Check for git conflicts"
      type: "BUILD"
      working_directory: "/buddy/ad-layers"
      docker_image_name: "alleyops/ci-resources"
      docker_image_tag: "7.4-fpm-wp"
      execute_commands:
        - "! git grep -E '<<<<<<< HEAD|=======.*>>>>>>>' \":!$0\""
      volume_mappings:
        - "/:/buddy/ad-layers"
      trigger_condition: "ALWAYS"
      shell: "BASH"
    - action: "Composer install"
      type: "BUILD"
      working_directory: "/buddy/ad-layers"
      docker_image_name: "alleyops/ci-resources"
      docker_image_tag: "7.4-fpm-wp"
      execute_commands:
        - "composer install -q"
      volume_mappings:
        - "/:/buddy/ad-layers"
      trigger_condition: "ALWAYS"
      shell: "BASH"
    - action: "Prepare WordPress test environment"
      type: "BUILD"
      working_directory: "/buddy/ad-layers"
      docker_image_name: "alleyops/ci-resources"
      docker_image_tag: "7.4-fpm-wp"
      execute_commands:
        - "# Clear out any previously cached testing folders."
        - "rm -rf .buddy-tests; mkdir -p .buddy-tests"
        - "rm -f object-cache.php"
        - ""
        - "# Install tests"
        - "# Set up the WordPress installation, skipping database creation"
        - "bash <(curl -s \"https://raw.githubusercontent.com/wp-cli/sample-plugin/master/bin/install-wp-tests.sh\") wordpress_test root root mysql latest true"
        - ""
        - "# Wire up object-cache and inform WordPress config about the server location"
        - "echo 'global $memcached_servers;' >> ${WP_TESTS_DIR}/wp-tests-config.php # Notably requires setting it globally"
        - "echo '$memcached_servers = array(\"memcached:11211\");' >> ${WP_TESTS_DIR}/wp-tests-config.php # See https://github.com/Automattic/wp-memcached/blob/master/readme.txt"
        - ""
        - "# Rsync wp-content to ${WP_CORE_DIR} for testing"
        - "rm -rf \"${WP_CORE_DIR}/wp-content/plugins\""
        - "mkdir -p \"${WP_CORE_DIR}/wp-content/plugins/ad-layers\""
        - "rsync -a \\"
        - "\t--exclude=.git \\"
        - "\t--exclude=.npm \\"
        - "\t--exclude=.buddy-tests \\"
        - "\t--exclude=node_modules \\"
        - "\t. \"${WP_CORE_DIR}/wp-content/plugins/ad-layers\""
        - ""
        - "# Wire up object cache."
        - "curl -s https://raw.githubusercontent.com/Automattic/wp-memcached/master/object-cache.php > ${WP_CONTENT_DIR}/object-cache.php"
        - ""
      volume_mappings:
        - "/:/buddy/ad-layers"
      trigger_condition: "ALWAYS"
      shell: "BASH"
    - action: "phpunit"
      type: "BUILD"
      working_directory: "/buddy/ad-layers"
      docker_image_name: "alleyops/ci-resources"
      docker_image_tag: "7.4-fpm-wp"
      execute_commands:
        - "# Install database tables."
        - "[[ $WP_MULTISITE -eq 1 ]] && WP_MULTISITE_STRING=\"run_ms_tests\" || WP_MULTISITE_STRING=\"no_ms_tests\""
        - "php ${WP_TESTS_DIR}/includes/install.php ${WP_TESTS_DIR}/wp-tests-config.php $WP_MULTISITE_STRING"
        - ""
        - "cd ${WP_CORE_DIR}/wp-content/plugins/ad-layers"
        - "WP_TESTS_SKIP_INSTALL=1 composer phpunit"
      setup_commands:
        - "echo \"extension=memcache.so\" >> /usr/local/etc/php/conf.d/buddy.ini"
      services:
        - type: "MYSQL"
          version: "5.7"
          connection:
            host: "mysql"
            port: 3306
            user: "root"
            password: "root"
            db: "wordpress_test"
        - type: "MEMCACHED"
          version: "1.5.6"
          connection:
            host: "memcached"
            port: 11211
      volume_mappings:
        - "/:/buddy/ad-layers"
      trigger_condition: "ALWAYS"
      shell: "BASH"
      run_next_parallel: true
    - action: "composer phpcs"
      type: "BUILD"
      working_directory: "/buddy/ad-layers"
      docker_image_name: "alleyops/ci-resources"
      docker_image_tag: "7.4-fpm-wp"
      execute_commands:
        - "composer phpcs"
      volume_mappings:
        - "/:/buddy/ad-layers"
      trigger_condition: "ALWAYS"
      shell: "BASH"
    - action: "npm audit"
      type: "BUILD"
      working_directory: "/buddy/ad-layers"
      docker_image_name: "library/node"
      docker_image_tag: "16"
      execute_commands:
        - "npm audit --audit-level=high --production --cache /buddy/ad-layers/.npm"
      volume_mappings:
        - "/:/buddy/ad-layers"
      trigger_condition: "ALWAYS"
      shell: "BASH"
    - action: "npm ci"
      type: "BUILD"
      working_directory: "/buddy/ad-layers"
      docker_image_name: "library/node"
      docker_image_tag: "16"
      execute_commands:
        - "npm ci --cache /buddy/ad-layers/.npm"
      volume_mappings:
        - "/:/buddy/ad-layers"
      trigger_condition: "ALWAYS"
      shell: "BASH"
    - action: "npm run lint"
      type: "BUILD"
      working_directory: "/buddy/ad-layers"
      docker_image_name: "library/node"
      docker_image_tag: "16"
      execute_commands:
        - "npm run lint"
      volume_mappings:
        - "/:/buddy/ad-layers"
      trigger_condition: "ALWAYS"
      shell: "BASH"
      run_next_parallel: true
    - action: "npm run stylelint"
      type: "BUILD"
      working_directory: "/buddy/ad-layers"
      docker_image_name: "library/node"
      docker_image_tag: "16"
      execute_commands:
        - "npm run stylelint"
      volume_mappings:
        - "/:/buddy/ad-layers"
      trigger_condition: "ALWAYS"
      shell: "BASH"
    - action: "npm run test"
      type: "BUILD"
      working_directory: "/buddy/ad-layers"
      docker_image_name: "library/node"
      docker_image_tag: "16"
      execute_commands:
        - "npm run test"
      volume_mappings:
        - "/:/buddy/ad-layers"
      trigger_condition: "ALWAYS"
      shell: "BASH"
    - action: "npm run build"
      type: "BUILD"
      working_directory: "/buddy/ad-layers"
      docker_image_name: "library/node"
      docker_image_tag: "16"
      execute_commands:
        - "npm run build"
      volume_mappings:
        - "/:/buddy/ad-layers"
      trigger_condition: "ALWAYS"
      shell: "BASH"
  variables:
    - key: "COMPOSER_HOME"
      value: "/buddy/ad-layers/.composer"
    - key: "WP_CORE_DIR"
      value: "/buddy/ad-layers/.buddy-tests/wordpress"
    - key: "WP_MULTISITE"
      value: "0"
    - key: "WP_TESTS_DIR"
      value: "/buddy/ad-layers/.buddy-tests/wordpress-tests-lib"
